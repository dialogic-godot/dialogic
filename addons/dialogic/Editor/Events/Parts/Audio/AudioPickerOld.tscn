[gd_scene load_steps=4 format=2]

[sub_resource type="GDScript" id=3]
script/source = "tool
extends \"res://addons/dialogic/Editor/Events/Parts/EventPart.gd\"

export (String) var event_name = 'Audio Event'

var file : String
var audio : String
var audio_bus : String = \"Master\"
var volume: float = 0

func _ready():
	load_audio('')
	AudioServer.connect(\"bus_layout_changed\", self, \"update_bus_selector\")
	$ButtonClear.icon = get_icon(\"Remove\", \"EditorIcons\")
	$ButtonPreviewPlay.icon = get_icon(\"Play\", \"EditorIcons\")
	update_bus_selector()

func _on_ButtonAudio_pressed():
	editor_reference.godot_dialog(\"*.wav, *.ogg, *.mp3\")
	editor_reference.godot_dialog_connect(self, \"_on_file_selected\")

func _on_file_selected(path, target):
	target.load_audio(path) # why is the targer needed? Couldn't it just call itself?

func load_audio(path: String):
	if not path.empty():
		$Name.text = path.get_file()
		$Name.hint_tooltip = path
		$ButtonAudio.hint_tooltip = path
		$ButtonClear.disabled = false
		$ButtonPreviewPlay.disabled = false
		file = path
		audio = 'play'
		emit_signal(\"audio_changed\", file, audio, audio_bus, volume)
		
		show_options()
	else:
		$Name.text = 'No sound (will stop previous '+event_name+')'
		file = ''
		audio = 'stop'
		emit_signal(\"audio_changed\", file, audio, audio_bus, volume)

		hide_options()

func load_data(data):
	# set the event_data
	.load_data(data)
	
	if data.has('audio'): audio = data['audio']
	if data.has('background-music'): audio = data['background-music']
	
	if data.has('audio_bus'): audio_bus = data['audio_bus']
	
	for idx in range($BusSelector.get_item_count()):
		if $BusSelector.get_item_text(idx) == audio_bus:
			$BusSelector.select(idx)
	
	if data.has('volume'): volume = data['volume']
	$Volume.value = volume
	load_audio(file)

func _on_ButtonPreviewPlay_pressed():
	if $AudioPreview.is_playing():
		$AudioPreview.stop()
	else:
		$AudioPreview.stream = load(file)
		$AudioPreview.bus = audio_bus
		$AudioPreview.volume_db = volume
		$AudioPreview.play()
		$ButtonPreviewPlay.icon = get_icon(\"Stop\", \"EditorIcons\")

func _on_AudioPreview_finished():
	$ButtonPreviewPlay.icon = get_icon(\"Play\", \"EditorIcons\")

func _on_ButtonClear_pressed():
	load_audio('')

func update_bus_selector():
	$BusSelector.clear()
	for i in range(AudioServer.bus_count):
		$BusSelector.add_item(AudioServer.get_bus_name(i))

func _on_BusSelector_item_selected(index):
	audio_bus = $BusSelector.get_item_text(index)
	emit_signal(\"audio_changed\", file, audio, audio_bus, volume)

func _on_Volume_value_changed(value):
	volume = value
	emit_signal(\"audio_changed\", file, audio, audio_bus, volume)

func show_options():
	$ButtonClear.show()
	$ButtonPreviewPlay.show()
	$BusSelector.show()
	$VolumeLabel.show()
	$Volume.show()

func hide_options():
	$ButtonClear.hide()
	$ButtonPreviewPlay.hide()
	$BusSelector.hide()
	$VolumeLabel.hide()
	$Volume.hide()
"

[sub_resource type="Image" id=4]
data = {
"data": PoolByteArray( 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ),
"format": "LumAlpha8",
"height": 16,
"mipmaps": false,
"width": 16
}

[sub_resource type="ImageTexture" id=2]
flags = 4
flags = 4
image = SubResource( 4 )
size = Vector2( 16, 16 )

[node name="AudioPicker" type="HBoxContainer"]
margin_right = 40.0
margin_bottom = 40.0
script = SubResource( 3 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Name" type="Label" parent="."]
margin_top = 13.0
margin_right = 266.0
margin_bottom = 27.0
mouse_filter = 1
text = "No sound (will stop previous Audio Event)"

[node name="ButtonAudio" type="Button" parent="."]
margin_left = 270.0
margin_right = 294.0
margin_bottom = 40.0
text = "..."

[node name="ButtonClear" type="Button" parent="."]
visible = false
margin_left = 297.0
margin_right = 325.0
margin_bottom = 40.0
disabled = true
icon = SubResource( 2 )

[node name="ButtonPreviewPlay" type="Button" parent="."]
visible = false
margin_left = 329.0
margin_right = 357.0
margin_bottom = 40.0
disabled = true
icon = SubResource( 2 )

[node name="BusSelector" type="OptionButton" parent="."]
visible = false
margin_left = 361.0
margin_right = 390.0
margin_bottom = 40.0
text = "Master"
items = [ "Master", null, false, 0, null ]
selected = 0

[node name="VolumeLabel" type="Label" parent="."]
visible = false
margin_left = 298.0
margin_top = 13.0
margin_right = 359.0
margin_bottom = 27.0
text = "  Volume:"

[node name="Volume" type="SpinBox" parent="."]
visible = false
margin_left = 363.0
margin_right = 437.0
margin_bottom = 40.0
min_value = -80.0
max_value = 24.0
step = 0.01
suffix = "dB"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Preview" type="Label" parent="."]
visible = false
margin_left = 329.0
margin_top = 13.0
margin_right = 357.0
margin_bottom = 27.0
custom_colors/font_color = Color( 1, 1, 1, 0.513726 )
text = "    ..."

[node name="AudioPreview" type="AudioStreamPlayer" parent="."]

[connection signal="pressed" from="ButtonAudio" to="." method="_on_ButtonAudio_pressed"]
[connection signal="pressed" from="ButtonClear" to="." method="_on_ButtonClear_pressed"]
[connection signal="pressed" from="ButtonPreviewPlay" to="." method="_on_ButtonPreviewPlay_pressed"]
[connection signal="item_selected" from="BusSelector" to="." method="_on_BusSelector_item_selected"]
[connection signal="value_changed" from="Volume" to="." method="_on_Volume_value_changed"]
[connection signal="finished" from="AudioPreview" to="." method="_on_AudioPreview_finished"]
